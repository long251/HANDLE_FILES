import React, { useEffect, useState } from 'react';
import TitleBreadcrumbs from '../../components/Breadcrumb/TitleBreadcrumb.tsx';
import {
  Button,
  ButtonGroup,
  FormLayout,
  IndexTable,
  Layout,
  LegacyCard,
  LegacyStack,
  Link,
  List,
  Modal,
  Page,
  PolarisIcons,
  Spinner,
  Sticky,
  Text,
} from 'pcs-polaris';
import ItemCreate from './ItemCreate.tsx';
import { clearToast, showToast } from '../../helpers/toast.ts';
import { apiClient } from '../../utils/api.ts';
import { useDispatch, useSelector } from 'react-redux';
import { AppState } from '../../store';
import { moneyAction } from '../../store/reducers/moneyReducer';
import { accountAction } from '../../store/reducers/accountReducer';
import { cartAction } from '../../store/reducers/cartReducer';
import { CreateForm, ecommerceOrderAction } from '../../store/reducers/ecommerceOrderReducer';
import { countryFromRoute, formatMoney } from '../../helpers/currency.ts';
import CustomImage from '../../components/CustomImage';
import { modalAction } from '../../store/reducers/modalReducer';
import { useNavigate } from 'react-router-dom';
import { IconVectorNext } from '../DeliveryBill/IconDeliveryBill.tsx';
import { IconArrowSeeMore } from '../Home/_components/Icons.tsx';
import {
  IconAddCart,
  IconBuyNow,
  IconImportEc,
  IconRefresh,
  IconRefreshMoney,
  IconSumMoney,
} from './IconEcommerce.tsx';
import { callback } from 'chart.js/helpers';

const MultiCreate = () => {
  const navigate = useNavigate();
  const [step, setStep] = useState(1);
  const reduxDispatch = useDispatch();
  const moneyState = useSelector((state: AppState) => state.money);
  const accountState = useSelector((state: AppState) => state.account);
  const ecommerceOrderState = useSelector((state: AppState) => state.ecommerceOrder);

  const emptyProduct: CreateForm = {
    url: '',
    name: '',
    price: '0',
    quantity: '1',

    options: [],
    option1Label: '',
    option1Value: '',
    option2Label: '',
    option2Value: '',
    option3Label: '',
    option3Value: '',

    images: [],

    tax: '0',
    shippingFee: '0',
    weight: '0',
    auctionNick: '',
    note: '',

    route: '',
    transport: '',
    destination: '',

    outOfStock: false,
    errors: [],

    searchRoute: 'Chọn tuyến',
    searchTransport: 'Chọn hình thức vận chuyển',
    searchDestination: 'Chọn điểm đến',
    extraOption: 3,
    variants: [],
    productData: null,
  };
  useEffect(() => {
    reduxDispatch(moneyAction.fetchWallet());
    reduxDispatch(accountAction.fetchAddresses());
  }, []);
  useEffect(() => {
    let addresses = accountState.addresses;
    if (addresses.length) {
      let defaultAddress = addresses[0];
      for (let i = 0; i < addresses.length; i++) {
        if (addresses[i]['active']) {
          defaultAddress = addresses[i];
          break;
        }
      }
      setAddress(defaultAddress);
    }
  }, [accountState.addresses]);

  useEffect(() => {
    if (ecommerceOrderState.create_forms.length == 0) {
      addProduct();
    }
  }, []);

  const addProduct = () => {
    reduxDispatch(
      ecommerceOrderAction.addForm({
        data: {
          form: emptyProduct,
        },
      }),
    );
  };

  const resetPage = () => {
    location.reload();
  };

  const [loadingAddToCart, setLoadingAddToCart] = useState(false);
  const [openModalGoCart, setOpenModalGoCart] = useState(false);
  const [loadingCompute, setLoadingCompute] = useState(false);

  const getValidators = () => {
    let errors = [];
    let products = ecommerceOrderState.create_forms;
    for (let i = 0; i < products.length; i++) {
      let rules = [];
      let product = products[i];
      if (!product.url) {
        rules.push('url');
      }
      if (!product.name) {
        rules.push('name');
      }
      if (Number(product.price) <= 0) {
        rules.push('price');
      }
      if (Number(product.quantity) <= 0) {
        rules.push('quantity');
      }
      if (!product.images.length) {
        rules.push('images');
      }
      if (!product.route) {
        rules.push('route');
      }
      if (product.route == 'JP-VN' && !product.transport) {
        rules.push('transport');
      }
      if (product.route == 'JP-VN' && product.transport == 'S' && !product.destination) {
        rules.push('destination');
      }
      for (let i = 0; i < product.options.length; i++) {
        if (product.options[i].selected.value == '') {
          rules.push(`option_${i}`);
        }
      }
      if (product.option1Label && !product.option1Value) {
        rules.push('option1_value');
      }
      if (product.option2Label && !product.option2Value) {
        rules.push('option2_value');
      }
      if (product.option3Label && !product.option3Value) {
        rules.push('option3_value');
      }
      if (product.url.includes('https://') && product.url.includes('yahoo') && product.url.includes('auction')) {
        if (!product.auctionNick) {
          rules.push('auction');
        }
      }
      errors.push(rules);
    }
    return errors;
  };

  const [computeData, setComputeData] = useState<any>([]);
  const [allAmount, setAllAmount] = useState(0);
  const [allTotalAmount, setAllTotalAmount] = useState(0);
  const [allAmountFeeBuy, setAllAmountFeeBuy] = useState(0);
  const [allAmountTax, setAllAmountTax] = useState(0);
  const [allAmountVCND, setAllAmountVCND] = useState(0);

  const [address, setAddress] = useState<any>(null);
  const [paymentMethod, setPaymentMethod] = useState('shipquocte_wallet');

  const buildPayload = (product: CreateForm) => {
    let payload = {
      url: product.url,
      name: product.name,
      quantity: product.quantity,
      price: product.price,
      route: product.route,
      image: product.images[0],
      images: product.images,
      tax: product.tax,
      shippingFee: product.shippingFee,
      weight: product.weight,
      note: product.note,
      trackingNote: product.auctionNick,
      input_from: 'form',
    };
    let attributes: any = {};
    for (let i = 0; i < product.options.length; i++) {
      let label = product.options[i].label;
      let valueLabel = product.options[i].selected.label;
      attributes[label] = valueLabel;
    }
    if (product.option1Value) {
      if (product.option1Label) {
        attributes[product.option1Label] = product.option1Value;
      } else {
        attributes['option1'] = product.option1Value;
      }
    }
    if (product.option2Value) {
      if (product.option2Label) {
        attributes[product.option2Label] = product.option2Value;
      } else {
        attributes['option2'] = product.option2Value;
      }
    }
    if (product.option3Value) {
      if (product.option3Label) {
        attributes[product.option3Label] = product.option3Value;
      } else {
        attributes['option3'] = product.option3Value;
      }
    }
    payload = Object.assign(payload, { attributes: attributes });
    if (product.route == 'JP-VN') {
      payload = Object.assign(payload, { transportType: product.transport });
      if (product.transport == 'S') {
        payload = Object.assign(payload, { destination: product.destination });
      }
    }
    return payload;
  };

  const handleCompute = async () => {
    if (loadingCompute || loadingAddToCart) {
      return;
    }
    clearToast();
    let products = ecommerceOrderState.create_forms;
    let hasOutOfStock = -1;
    for (let i = 0; i < products.length; i++) {
      if (products[i].outOfStock) {
        hasOutOfStock = i;
        break;
      }
    }
    if (hasOutOfStock > -1) {
      showToast(`Vui lòng kiểm tra lại. Sản phẩm ${hasOutOfStock + 1} đã hết hàng`, 'error');
      return;
    }

    let validators = getValidators();
    let error = false;
    for (let i = 0; i < products.length; i++) {
      if (validators[i].length) {
        error = true;
      }
      reduxDispatch(
        ecommerceOrderAction.updateFormField({
          data: {
            index: i,
            field: 'errors',
            value: validators[i],
          },
        }),
      );
    }
    if (error) {
      showToast('Vui lòng nhập đủ thông tin', 'error');
      return;
    }
    setLoadingCompute(true);
    let productErrors = [];

    let tmpAllAmount = 0;
    let tmpAllTotalAmount = 0;
    let tmpAllAmountFeeBuy = 0;
    let tmpAllAmountTax = 0;
    let tmpAllAmountVCND = 0;

    let tmpComputeData = [];

    for (let i = 0; i < products.length; i++) {
      try {
        let payload = buildPayload(products[i]);
        // console.log(payload);

        let response = await apiClient.post('/api/ShoppingCart/AddShoppingNoCart', payload);
        if (response.data.status) {
          let cartItems = response.data.data;
          for (let i = 0; i < cartItems.length; i++) {
            tmpAllAmount += cartItems[i]['amount'];
            tmpAllTotalAmount += cartItems[i]['totalAmount'];
            tmpAllAmountFeeBuy += cartItems[i]['amountFeeBuy'];
            tmpAllAmountTax += cartItems[i]['amountTax'];
            tmpAllAmountVCND += cartItems[i]['amountVCND'];
            tmpComputeData.push(cartItems[i]);
          }
        } else {
          productErrors.push(products[i]);
        }
      } catch (e) {
        console.log(e);
        productErrors.push(products[i]);
      }
    }

    setAllAmount(tmpAllAmount);
    setAllTotalAmount(tmpAllTotalAmount);
    setAllAmountFeeBuy(tmpAllAmountFeeBuy);
    setAllAmountTax(tmpAllAmountTax);
    setAllAmountVCND(tmpAllAmountVCND);
    setComputeData(tmpComputeData);

    setStep(2);
    setLoadingCompute(false);
  };

  const handleAddToCart = async () => {
    if (loadingCompute || loadingAddToCart) {
      return;
    }
    clearToast();
    let products = ecommerceOrderState.create_forms;
    let hasOutOfStock = -1;
    for (let i = 0; i < products.length; i++) {
      if (products[i].outOfStock) {
        hasOutOfStock = i;
        break;
      }
    }
    if (hasOutOfStock > -1) {
      showToast(`Vui lòng kiểm tra lại. Sản phẩm ${hasOutOfStock + 1} đã hết hàng`, 'error');
      return;
    }

    let validators = getValidators();
    let error = false;
    for (let i = 0; i < products.length; i++) {
      if (validators[i].length) {
        error = true;
      }
      reduxDispatch(
        ecommerceOrderAction.updateFormField({
          data: {
            index: i,
            field: 'errors',
            value: validators[i],
          },
        }),
      );
    }
    if (error) {
      showToast('Vui lòng nhập đủ thông tin', 'error');
      return;
    }

    setLoadingAddToCart(true);
    let productErrors = [];

    for (let i = 0; i < products.length; i++) {
      try {
        let payload = buildPayload(products[i]);
        console.log(payload);

        let response = await apiClient.post('/api/ShoppingCart/AddShoppingCart', payload);
        if (response.data.status) {
          let cartItems = response.data.data;
          console.log(cartItems);
        } else {
          productErrors.push(products[i]);
        }
      } catch (e) {
        console.log(e);
        productErrors.push(products[i]);
      }
    }
    let productLength = products.length;
    let productErrorLength = productErrors.length;
    if (productErrorLength) {
      if (productLength == productErrorLength) {
        showToast(`Đã xảy ra lỗi`, 'error');
      } else {
        showToast(
          `Đã thêm ${
            productLength - productErrorLength
          } sản phẩm vào giỏ hàng, ${productErrorLength} sản phẩm chưa được thêm vào giỏ hàng`,
          'success',
        );
        reduxDispatch(cartAction.fetchCart());
        reduxDispatch(
          ecommerceOrderAction.setForms({
            data: {
              forms: [],
            },
          }),
        );
        setTimeout(function () {
          reduxDispatch(
            ecommerceOrderAction.setForms({
              data: {
                form: emptyProduct,
              },
            }),
          );
        }, 200);
      }
    } else {
      showToast(`Đã thêm ${productLength} sản phẩm vào giỏ hàng`, 'success');
      reduxDispatch(cartAction.fetchCart());
      reduxDispatch(
        ecommerceOrderAction.setForms({
          data: {
            forms: [],
          },
        }),
      );
      setTimeout(function () {
        reduxDispatch(
          ecommerceOrderAction.addForm({
            data: {
              form: emptyProduct,
            },
          }),
        );
      }, 200);
      setOpenModalGoCart(true);
    }

    setLoadingAddToCart(false);
  };

  const [openModalSelectAddress, setOpenModalSelectAddress] = useState(false);
  const [loadingCreateOrder, setLoadingCreateOrder] = useState(false);

  const handleOrder = async (item: any) => {
    let orderReturnCodes = [];
    try {
      let payload = {
        customerDistrict: address?.district,
        customerAddress: address?.address,
        customerPhone: address?.phone,
        customerName: address?.name,
        customerProvince: address?.province,
        customerWard: address?.ward,
        orderInfo: buildPayload(item),
        note: '',
        paymentMethod: paymentMethod,
      };
      let response = await apiClient.post('/api/Order/AddNewOrderEcoNoCart', payload);
      if (response.data.status) {
        let data = response.data.data;
        let orders = data.ordersReturn;
        if (Array.isArray(orders)) {
          for (let i = 0; i < orders.length; i++) {
            orderReturnCodes.push(orders[i].orderCode);
          }
        }
      }
    } catch (e) {
      console.log(e);
    }
    return orderReturnCodes;
  };

  const handleCreateMultiOrder = async () => {
    if (loadingCreateOrder) {
      return;
    }
    clearToast();
    if (!address) {
      showToast('Vui lòng chọn địa chỉ nhận hàng', 'error');
      return;
    }
    if (paymentMethod == 'shipquocte_wallet') {
      let wallet = moneyState.wallet?.cash ?? 0;
      if (wallet < allTotalAmount) {
        showToast('Số dư ví không đủ', 'error');
        return;
      }
    }
    setLoadingCreateOrder(true);
    let orderCodes = [];

    let data = ecommerceOrderState.create_forms;
    for (let i = 0; i < data.length; i++) {
      let orderReturnCodes = await handleOrder(data[i]);
      for (let j = 0; j < orderReturnCodes.length; j++) {
        orderCodes.push(orderReturnCodes[j]);
      }
    }

    if (orderCodes.length) {
      let qrCodeData = null;
      let ordersReturn = [];
      reduxDispatch(
        ecommerceOrderAction.setForms({
          data: {
            forms: [],
          },
        }),
      );
      let response = await apiClient.post('/api/Order/GetQRByOrderCodes', orderCodes);
      showToast('Tạo đơn thành công', 'success');

      if (response.data.status) {
        let dataPayment = response.data.data;
        qrCodeData = dataPayment.qrCodeData;
        let orders = dataPayment.ordersReturn;
        if (Array.isArray(orders)) {
          ordersReturn = orders;
          let codes = [];
          for (let i = 0; i < orders.length; i++) {
            codes.push(orders[i].orderCode);
          }
        }
        if (paymentMethod == 'shipquocte_wallet') {
          qrCodeData = null;
        }
        navigate('/don-hang-ecommerce/thank-you', {
          state: {
            checkoutEcommerce: {
              qrCodeData: qrCodeData,
              orderReturn: ordersReturn,
            },
          },
        });
      } else {
        navigate('/don-hang-ecommerce');
        // navigate(`/don-hang-ecommerce/thanh-toan?items=${orderCodes.join(',')}`);
      }
    } else {
      showToast('Tạo đơn không thành công', 'error');
      return;
    }
    setLoadingCreateOrder(false);
  };

  const groupedData = computeData.reduce((acc: any, item: any) => {
    const route = item.route || 'Tuyến không xác định';
    if (!acc[route]) {
      acc[route] = [];
    }
    acc[route].push(item);
    return acc;
  }, {});

  const sqtWallet = moneyState.wallet?.cash ?? 0;

  const handleDepositMoney = () => {
    reduxDispatch(
      modalAction.openModal({
        type: 'deposit_money',
        title: 'Nạp tiền vào tài khoản',
        data: {
          callback: () => {},
        },
      }),
    );
  };
  const handleRefresh = () => {
    reduxDispatch(moneyAction.fetchWallet());
  };
  
  return (
    <div>
      <div className={'Polaris-Custom Title_Breadcrumb'}>
        <Page
          //@ts-ignore
          title={<TitleBreadcrumbs breadcrumbs={[{ title: 'Tạo đơn hàng Ecommerce', url: '' }]} />}
          secondaryActions={[
            // {
            //   content: 'Làm mới dữ liệu',
            //   icon: PolarisIcons.RefreshMajor,
            //   destructive: true,
            //   onAction() {
            //     resetPage();
            //   },
            // },
            // {
            //   content: 'Import nhiều đơn',
            //   icon: PolarisIcons.UploadMajor,
            //   url: '/don-hang-ecommerce/tao-moi/import',
            // },
            {
              //@ts-ignore
              content: (
                <div className='Button_Refresh_Create_Ec'>
                  <IconRefresh /> Làm mới dữ liệu
                </div>
              ),
              onAction() {
                resetPage();
              },
            },
            {
              //@ts-ignore
              content: (
                <div className='Button_Import_Create_Ec'>
                  <IconImportEc /> Import nhiều đơn
                </div>
              ),
              url: '/don-hang-ecommerce/tao-moi/import',
            },
          ]}
        >
          {step == 1 ? (
            <Layout>
              {ecommerceOrderState.create_forms.map((_item: any, index: number) => {
                return <ItemCreate key={index} index={index} />;
              })}
              <Layout.Section>
                <LegacyStack distribution={'center'}>
                  <Button
                    onClick={() => {
                      addProduct();
                    }}
                    icon={PolarisIcons.AddProductMajor}
                  >
                    Thêm sản phẩm
                  </Button>
                </LegacyStack>
              </Layout.Section>
            </Layout>
          ) : null}
          {step == 2 ? (
            <Layout>
              <Layout.Section>
                <LegacyCard>
                  <div style={{ padding: '20px' }}>
                    <div className={'Compute_IndexTable IndexTable--NoSticky'}>
                      {Object.keys(groupedData).map((route: string, routeIdx: number) => (
                        <div
                          key={routeIdx}
                          style={{
                            marginBottom: routeIdx !== Object.keys(groupedData).length - 1 ? '20px' : '0px',
                            borderBottom:
                              routeIdx !== Object.keys(groupedData).length - 1 ? '1px dashed #D1D5DB' : 'none',
                            // paddingBottom: '20px'
                          }}
                        >
                          <IndexTable
                            selectable={false}
                            headings={[
                              {
                                title: ` ${countryFromRoute(route)} »`,
                              },
                              { title: '' },
                              { title: '' },
                              { title: '' },
                              { title: '' },
                              { title: '' },
                            ]}
                            itemCount={groupedData[route].length}
                          >
                            {groupedData[route].map((item: any, index: number) => {
                              let attributes = item.attributes;
                              let url = item.url;
                              return (
                                <IndexTable.Row
                                  id={item.id}
                                  key={index}
                                  position={index}
                                  onClick={() => {
                                    console.log('');
                                  }}
                                >
                                  <IndexTable.Cell>
                                    <img
                                      src={item.image}
                                      alt={item.name}
                                      style={{
                                        width: '60px',
                                        height: '60px',
                                        objectFit: 'cover',
                                        objectPosition: 'top',
                                      }}
                                    />
                                  </IndexTable.Cell>
                                  <IndexTable.Cell>
                                    <div className={'Cell-ProductName'}>
                                      <Link onClick={() => window.open(url, '_blank')} removeUnderline url={'#'}>
                                        {item.name}
                                      </Link>
                                    </div>
                                  </IndexTable.Cell>
                                  <IndexTable.Cell>
                                    {item.attributes && Object.keys(item.attributes).length > 0 ? (
                                      <div style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>
                                        {Object.keys(item.attributes).map((key: string, idx: number) => (
                                          <Text key={idx} as={'p'} variant={'bodySm'}>
                                            {key}: {item.attributes[key] ? item.attributes[key] : 'N/A'}
                                          </Text>
                                        ))}
                                      </div>
                                    ) : (
                                      ''
                                    )}
                                  </IndexTable.Cell>

                                  <IndexTable.Cell>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>
                                      <Text as={'p'} variant={'bodyMd'}>
                                        {formatMoney(item.priceVND, 'VND')}
                                      </Text>
                                      <Text as={'p'} variant={'bodySm'}>
                                        ~{formatMoney(item.price, item.currency)}
                                      </Text>
                                    </div>
                                  </IndexTable.Cell>
                                  <IndexTable.Cell>x{item.quantity}</IndexTable.Cell>
                                  <IndexTable.Cell>{formatMoney(item.amount, 'VND')}</IndexTable.Cell>
                                </IndexTable.Row>
                              );
                            })}
                          </IndexTable>
                        </div>
                      ))}
                    </div>
                  </div>
                  <div style={{ padding: '0 20px' }}>
                    <div style={{ border: '1px solid #D1D5DB' }}>
                      <div
                        style={{
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center',
                          backgroundColor: '#D1D5DB',
                          padding: '16px 20px',
                        }}
                      >
                        <div style={{ fontWeight: '700', fontSize: '14px' }}>Địa chỉ nhận hàng</div>
                        <div
                          style={{
                            display: 'flex',
                            gap: '4px',
                            justifyContent: 'center',
                            alignItems: 'center',
                            userSelect: 'none',
                            cursor: 'pointer',
                          }}
                          onClick={() => setOpenModalSelectAddress(true)}
                        >
                          Sổ địa chỉ <IconArrowSeeMore />
                        </div>
                      </div>
                      {accountState.addresses_loading ? (
                        <LegacyStack distribution={'center'}>
                          <Spinner size={'small'} />
                        </LegacyStack>
                      ) : (
                        <>
                          {address ? (
                            <div style={{ display: 'flex', alignItems: 'center', gap: '32px' }}>
                              <div style={{ padding: '27px 52px 27px 20px', position: 'relative', fontWeight: '700' }}>
                                {address.name}
                                <div
                                  style={{
                                    content: '""',
                                    position: 'absolute',
                                    right: '-20px',
                                    top: '10px',
                                    bottom: '10px',
                                    width: '1px',
                                    backgroundColor: '#D1D5DB',
                                  }}
                                />
                              </div>
                              <div style={{ display: 'flex', flexDirection: 'column', padding: '16px', gap: '4px' }}>
                                <div style={{ fontWeight: '700' }}>{address.phone}</div>
                                <div>{address.fullAddress}</div>
                              </div>
                            </div>
                          ) : (
                            <Text as={'span'} variant={'bodyMd'}>
                              Chưa có địa chỉ nhận hàng
                            </Text>
                          )}
                        </>
                      )}
                    </div>
                  </div>
                  <div style={{ padding: '20px' }}>
                    <div style={{ border: '1px solid #D1D5DB' }}>
                      <div style={{ padding: '16px 20px', backgroundColor: '#D1D5DB', fontWeight: '700' }}>
                        Phương thức thanh toán
                      </div>
                      <div className='Style_Payment_Methods'>
                        <div className='Border_Payment_Methods'>
                          <div
                            style={{
                              background: paymentMethod == 'shipquocte_wallet' ? '#0B3558' : '#EFF1F4',
                              color: paymentMethod == 'shipquocte_wallet' ? 'white' : '#0B3558',
                              display: 'flex',
                              padding: '16px 20px',
                              borderRadius: 4,
                              // alignItems: 'center',
                              // justifyContent: 'center',
                              gap: 8,
                              cursor: 'pointer',
                            }}
                            onClick={() => setPaymentMethod('shipquocte_wallet')}
                          >
                            <svg
                              width='22'
                              height='20'
                              viewBox='0 0 22 20'
                              fill='none'
                              xmlns='http://www.w3.org/2000/svg'
                            >
                              <path
                                d='M1 10.6099H18'
                                stroke='currentColor'
                                strokeWidth='1.5'
                                strokeMiterlimit='10'
                                strokeLinecap='round'
                                strokeLinejoin='round'
                              />
                              <path
                                d='M18 8.28005V15.43C17.97 18.28 17.19 19 14.22 19H4.78003C1.76003 19 1 18.2501 1 15.2701V8.28005C1 5.58005 1.63 4.71005 4 4.57005C4.24 4.56005 4.50003 4.55005 4.78003 4.55005H14.22C17.24 4.55005 18 5.30005 18 8.28005Z'
                                stroke='currentColor'
                                strokeWidth='1.5'
                                strokeLinecap='round'
                                strokeLinejoin='round'
                              />
                              <path
                                d='M21 4.73V11.72C21 14.42 20.37 15.29 18 15.43V8.28C18 5.3 17.24 4.55 14.22 4.55H4.78003C4.50003 4.55 4.24 4.56 4 4.57C4.03 1.72 4.81003 1 7.78003 1H17.22C20.24 1 21 1.75 21 4.73Z'
                                stroke='currentColor'
                                strokeWidth='1.5'
                                strokeLinecap='round'
                                strokeLinejoin='round'
                              />
                              <path
                                d='M4.25 15.8101H5.96997'
                                stroke='currentColor'
                                strokeWidth='1.5'
                                strokeMiterlimit='10'
                                strokeLinecap='round'
                                strokeLinejoin='round'
                              />
                              <path
                                d='M8.10986 15.8101H11.5499'
                                stroke='currentColor'
                                strokeWidth='1.5'
                                strokeMiterlimit='10'
                                strokeLinecap='round'
                                strokeLinejoin='round'
                              />
                            </svg>

                            <span>{`SQT Wallet`}</span>
                          </div>
                          <div
                            style={{
                              background: paymentMethod == 'bank_transfer' ? '#0B3558' : '#EFF1F4',
                              color: paymentMethod == 'bank_transfer' ? 'white' : '#0B3558',
                              display: 'flex',
                              padding: '16px 20px',
                              borderRadius: 4,
                              // alignItems: 'center',
                              // justifyContent: 'center',
                              gap: 8,
                              cursor: 'pointer',
                            }}
                            onClick={() => setPaymentMethod('bank_transfer')}
                          >
                            <svg
                              width='22'
                              height='20'
                              viewBox='0 0 22 20'
                              fill='none'
                              xmlns='http://www.w3.org/2000/svg'
                            >
                              <path
                                d='M12 9.16919H6'
                                stroke='currentColor'
                                strokeWidth='1.5'
                                strokeLinecap='round'
                                strokeLinejoin='round'
                              />
                              <path
                                d='M1 9.16939V4.62757C1 2.62208 2.65 1 4.69 1H10.31C12.35 1 14 2.24851 14 4.25399'
                                stroke='currentColor'
                                strokeWidth='1.5'
                                strokeLinecap='round'
                                strokeLinejoin='round'
                              />
                              <path
                                d='M16.48 10.2015C15.98 10.6734 15.74 11.4009 15.94 12.148C16.19 13.0623 17.11 13.6423 18.07 13.6423H19V15.0678C19 17.2404 17.21 19.0001 15 19.0001H5C2.79 19.0001 1 17.2404 1 15.0678V8.18622C1 6.01362 2.79 4.25391 5 4.25391H15C17.2 4.25391 19 6.02345 19 8.18622V9.61164H17.92C17.36 9.61164 16.85 9.82795 16.48 10.2015Z'
                                stroke='currentColor'
                                strokeWidth='1.5'
                                strokeLinecap='round'
                                strokeLinejoin='round'
                              />
                              <path
                                d='M21 10.6146V12.6397C21 13.1902 20.5399 13.6425 19.9699 13.6425H18.0399C16.9599 13.6425 15.97 12.8658 15.88 11.8041C15.82 11.1848 16.0599 10.6048 16.4799 10.2017C16.8499 9.82813 17.36 9.61182 17.92 9.61182H19.9699C20.5399 9.61182 21 10.0641 21 10.6146Z'
                                stroke='currentColor'
                                strokeWidth='1.5'
                                strokeLinecap='round'
                                strokeLinejoin='round'
                              />
                            </svg>

                            <span>Chuyển khoản</span>
                          </div>
                        </div>
                        {/* content payment methods */}
                        <div style={{ padding: '20px', flex: '1', display: 'flex', alignItems: 'center' }}>
                          {paymentMethod === 'shipquocte_wallet' && sqtWallet < allTotalAmount && (
                            <div style={{ display: 'flex', gap: '20px', flexDirection: 'column' }}>
                              <div
                                style={{
                                  display: 'flex',
                                  justifyContent: 'space-between',
                                  flex: '1',
                                  flexWrap: 'wrap',
                                  gap: '12px',
                                }}
                              >
                                <div
                                  style={{
                                    padding: '24px 68px',
                                    display: 'flex',
                                    justifyContent: 'center',
                                    alignItems: 'center',
                                    flexDirection: 'column',
                                    gap: '6px',
                                    backgroundColor: '#EFF1F4',
                                    borderBottom: '2px solid #0B3558',
                                  }}
                                >
                                  <div style={{ fontSize: '13px' }}>Tổng tiền trong ví</div>
                                  <div style={{ fontWeight: '700', fontSize: '24px' }}>
                                    {moneyState.wallet_loading ? (
                                      <Spinner size='small' />
                                    ) : (
                                      formatMoney(moneyState.wallet?.cash ?? 0, 'VND')
                                    )}
                                  </div>
                                </div>
                                <div style={{ display: 'flex', gap: '16px', alignItems: 'center' }}>
                                  <div className='Button_Deposit_Create_Ecommerce' onClick={handleDepositMoney}>
                                    <IconSumMoney /> Nạp tiền
                                  </div>
                                  <div className='Button_Refresh_Create_Ecommerce' onClick={handleRefresh}>
                                    <IconRefreshMoney /> Làm mới
                                  </div>
                                </div>
                              </div>
                              <div style={{ borderBottom: '1px solid #D1D5DB' }}></div>

                              <div style={{ color: '#A91116' }}>
                                Số dư tài khoản trong ví của bạn không đủ để thực hiện giao dịch. Xin quý khách vui lòng
                                nạp thêm bằng cách nhấn nút 'Nạp tiền'.
                              </div>
                            </div>
                          )}
                          {paymentMethod === 'shipquocte_wallet' && sqtWallet > allTotalAmount && (
                            <div
                              style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                flex: '1',
                                flexWrap: 'wrap',
                                gap: '12px',
                                alignItems: 'center',
                              }}
                            >
                              <div
                                style={{
                                  padding: '24px 68px',
                                  display: 'flex',
                                  justifyContent: 'center',
                                  alignItems: 'center',
                                  flexDirection: 'column',
                                  gap: '6px',
                                  backgroundColor: '#EFF1F4',
                                  borderBottom: '2px solid #0B3558',
                                  borderRadius: '4px 4px 0 0',
                                }}
                              >
                                <div style={{ fontSize: '13px' }}>Tổng tiền trong ví</div>
                                <div style={{ fontWeight: '700', fontSize: '24px' }}>
                                  {moneyState.wallet_loading ? (
                                    <Spinner size='small' />
                                  ) : (
                                    formatMoney(moneyState.wallet?.cash ?? 0, 'VND')
                                  )}
                                </div>
                              </div>
                              <div style={{ display: 'flex', gap: '16px', alignItems: 'center' }}>
                                <div className='Button_Deposit_Create_Ecommerce' onClick={handleDepositMoney}>
                                  <IconSumMoney /> Nạp tiền
                                </div>
                                <div className='Button_Refresh_Create_Ecommerce' onClick={handleRefresh}>
                                  <IconRefreshMoney /> Làm mới
                                </div>
                              </div>
                            </div>
                          )}
                          {paymentMethod === 'bank_transfer' && (
                            <div>
                              <div style={{ marginLeft: '12px' }}>
                                Quý Khách thực hiện thanh toán đến số tài khoản của SHIPQUOCTE bằng cách:
                              </div>
                              <ul>
                                <li>Chuyển khoản bằng Internet Banking</li>
                                <li>Chuyển tại máy ATM</li>
                                <li>Chuyển tại quầy giao dịch ngân hàng</li>
                              </ul>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                </LegacyCard>
              </Layout.Section>
              <Layout.Section secondary>
                  <div className='StickyWrapper'>
                    <Sticky
                      onStickyChange={(isSticky) => {
                        if (isSticky) {
                          let el: HTMLDivElement | null = document.querySelector('.StickyWrapper .Polaris-LegacyCard');
                          if (el && el.parentElement) {
                            el.parentElement.style.top = 'calc(56px + 20px)';
                          }
                        }
                      }}
                    >
                      <LegacyCard>
                        <LegacyCard.Section>
                          <div style={{ border: '1px solid #D1D5DB' }}>
                            <div style={{ padding: '16px 20px', fontWeight: '700', backgroundColor: '#D1D5DB' }}>
                              Thông tin thanh toán
                            </div>
                            <div>
                              <div className='Info_Payment_Ecommerce'>
                                <div>Tổng tiền sản phẩm</div>
                                <div>{formatMoney(allAmount, 'VND')}</div>
                              </div>
                              <div style={{ borderTop: '1px solid #D1D5DB' }}></div>
                              <div className='Info_Payment_Ecommerce'>
                                <div>Phụ phí</div>
                                <div>{formatMoney(allAmountFeeBuy + allAmountTax + allAmountVCND, 'VND')}</div>
                              </div>
                              <div style={{ borderTop: '1px dashed #D1D5DB' }}></div>
                              <div className='Info_Payment_Ecommerce' style={{ fontWeight: '400' }}>
                                <div>-- Công mua</div>
                                <div>{formatMoney(allAmountFeeBuy, 'VND')}</div>
                              </div>
                              <div style={{ borderTop: '1px dashed #D1D5DB' }}></div>
                              <div className='Info_Payment_Ecommerce' style={{ fontWeight: '400' }}>
                                <div>-- Thuế</div>
                                <div>{formatMoney(allAmountTax, 'VND')}</div>
                              </div>
                              <div style={{ borderTop: '1px dashed #D1D5DB' }}></div>
                              <div className='Info_Payment_Ecommerce' style={{ fontWeight: '400' }}>
                                <div>-- Phí vận chuyển nội địa</div>
                                <div>{formatMoney(allAmountVCND, 'VND')}</div>
                              </div>
                              <div style={{ borderTop: '1px solid #D1D5DB' }}></div>
                              <div className='Info_Payment_Ecommerce'>
                                <div>Tổng tiền tạm tính</div>
                                <div>{formatMoney(allTotalAmount, 'VND')}</div>
                              </div>
                            </div>
                          </div>
                        </LegacyCard.Section>
                      </LegacyCard>
                    </Sticky>
                  </div>
              </Layout.Section>
            </Layout>
          ) : null}
          {step == 1 ? (
            <div className='Create_Input_Product_Ecommerce'>
              <div style={{ fontWeight: '700', fontSize: '16px', color: '#FFFFFF', whiteSpace: 'nowrap' }}>
                {ecommerceOrderState.create_forms.length} sản phẩm
              </div>
              <div
                style={{
                  display: 'flex',
                  gap: '16px',
                  justifyContent: 'center',
                  alignItems: 'center',
                  // flexWrap: 'wrap',
                }}
              >
                {loadingAddToCart ? (
                  <Spinner size='small' />
                ) : (
                  <div
                    className='Button_Add_Cart_New'
                    onClick={() => {
                      handleAddToCart();
                    }}
                  >
                    <IconAddCart /> Thêm giỏ hàng
                  </div>
                )}
                {loadingCompute ? (
                  <Spinner size='small' />
                ) : (
                  <div
                    className='Button_Add_Cart_New_Buy_Now'
                    onClick={() => {
                      handleCompute();
                    }}
                  >
                    <IconBuyNow /> Mua ngay
                  </div>
                )}
              </div>
            </div>
          ) : null}
          {step == 2 ? (
            <div className='Create_Input_Tracking_Code'>
              <div style={{ color: '#85C0FF', fontSize: '20px' }}>Tổng tiền: {formatMoney(allTotalAmount, 'VND')}</div>
              <div
                style={{
                  display: 'flex',
                  gap: '16px',
                  flexDirection: 'row',
                  justifyContent: 'center',
                  alignItems: 'center',
                }}
              >
                <div onClick={() => setStep(1)} className='Back_Step1_Create_Ec'>
                  Quay lại
                </div>
                <div className='Button_Order_Ecommerce'>
                  <Button
                    primary
                    loading={loadingCreateOrder}
                    onClick={() => {
                      handleCreateMultiOrder();
                    }}
                  >
                    {`Đặt hàng`}
                  </Button>
                </div>
              </div>
            </div>
          ) : null}
        </Page>

        <Modal
          title={'Chọn địa chỉ nhận hàng'}
          open={openModalSelectAddress}
          onClose={() => setOpenModalSelectAddress(false)}
        >
          <Modal.Section flush>
            <LegacyCard
              actions={[
                {
                  content: 'Thêm địa chỉ mới',
                  onAction() {
                    setOpenModalSelectAddress(false);
                    reduxDispatch(
                      modalAction.openModal({
                        type: 'create_address',
                        title: 'Thêm địa chỉ nhận hàng',
                        data: {
                          callback: () => {
                            setOpenModalSelectAddress(true);
                          },
                        },
                      }),
                    );
                  },
                },
              ]}
            >
              {accountState.addresses.map((item: any, index: number) => (
                <LegacyCard.Section key={index} flush subdued={address && item.id == address.id}>
                  <div
                    style={{
                      cursor: 'pointer',
                      width: '100%',
                      padding: '12px 20px',
                    }}
                    onClick={() => {
                      setAddress(item);
                      setOpenModalSelectAddress(false);
                    }}
                  >
                    <Text as={'h2'} variant={'bodyMd'} fontWeight={'semibold'}>
                      {item.name}
                    </Text>
                    <div>{item.phone}</div>
                    <div>{item.fullAddress}</div>
                  </div>
                </LegacyCard.Section>
              ))}
            </LegacyCard>
          </Modal.Section>
        </Modal>

        <Modal
          fullScreen
          open={openModalGoCart}
          title={
            <LegacyStack distribution={'center'} alignment={'center'}>
              <Text as={'h2'} variant={'headingLg'}>
                Thêm giỏ hàng thành công
              </Text>
              <Text as={'h2'} variant={'headingLg'}>
                🎉
              </Text>
            </LegacyStack>
          }
          primaryAction={{
            content: 'Có, đến giỏ hàng',
            icon: PolarisIcons.CartMajor,
            url: '/shopping/cart',
          }}
          secondaryActions={[
            {
              content: 'Tiếp tục tạo đơn',
              icon: PolarisIcons.AddProductMajor,
              onAction() {
                setOpenModalGoCart(false);
              },
            },
          ]}
          onClose={() => {
            setOpenModalGoCart(false);
          }}
        >
          <Modal.Section>
            <Text as={'p'} variant={'bodyMd'}>
              Bạn có muốn đến giỏ hàng và thanh toán không?
            </Text>
          </Modal.Section>
        </Modal>
      </div>
    </div>
  );
};

export default MultiCreate;
